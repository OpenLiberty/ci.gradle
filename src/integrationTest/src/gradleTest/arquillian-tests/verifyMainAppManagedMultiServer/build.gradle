apply plugin: 'war'

buildscript {
    repositories {
        mavenLocal()
        mavenCentral()
        maven {
            url 'https://oss.sonatype.org/content/repositories/snapshots/'
        }
    }
    dependencies {
        classpath group: 'net.wasdev.wlp.gradle.plugins', name: 'liberty-gradle-plugin', version: lgpVersion
    }
}

project.buildDir = '../build'

dependencies {
    compile "org.jboss.arquillian.container:arquillian-wlp-managed-8.5:1.0.0.CR1"
}

liberty{
    installDir = "${project.projectDir}/../../../../wlp"
    userDir = "${rootProject.projectDir}/build/wlp/usr/"
    servers {
        libertyProjectServer1 {
            configFile = file("${rootProject.projectDir}/src/main/liberty/config/server.xml")
            bootstrapProperties = ['build.directory': buildDir, 'default.http.port': "${testServerHttpPort}" , 'default.https.port': "${testServerHttpsPort}", 'appContext': "${warContext}", 'appLocation': "${rootProject.war.archiveName}"]
            apps = [rootProject.war]
            looseApplication = true
            verifyAppStartTimeout = 30
        }
        libertyProjectServer2 {
            configFile = file("${rootProject.projectDir}/src/main/liberty/config/server.xml")
            bootstrapProperties = ['build.directory': buildDir, 'default.http.port': "${testServerHttpPort}" , 'default.https.port': "${testServerHttpsPort}", 'appContext': "${warContext}", 'appLocation': "${rootProject.war.archiveName}"]
            apps = [rootProject.war]
            looseApplication = true
            verifyAppStartTimeout = 30
        }
    }
}

arquillianConfiguration {
    arquillianProperties = ['verifyApps': 'arquillian-tests']
    skipIfArquillianXmlExists = true
}

task deleteArquillianXml1 (type:Delete) {
    delete '../build/resources/test/arquillian.xml'
}

task deleteArquillianXml2 (type:Delete) {
    delete '../build/resources/test/arquillian.xml'
}

war.enabled = false

afterEvaluate {
    // tasks.withType(ConfigureArquillianTask).each { dependsOn 'deleteArquillianXml' }
    tasks.getByName('configureArquillian-libertyProjectServer1').dependsOn 'deleteArquillianXml1'
    tasks.getByName('configureArquillian-libertyProjectServer2').dependsOn 'deleteArquillianXml2'
}
