apply plugin: 'war'

buildscript {
    repositories {
        mavenLocal()
        mavenCentral()
        maven {
            url 'https://oss.sonatype.org/content/repositories/snapshots/'
        }
    }
    dependencies {
        classpath "io.openliberty.tools:liberty-gradle-plugin:$lgpVersion"
    }
}

project.buildDir = '../build'

dependencies {
    compile 'io.openliberty.arquillian:arquillian-liberty-managed:1.0.2'
}

liberty{
    installDir = "${buildDir}/wlp"
    servers {
        libertyProjectServer1 {
            serverXmlFile = file("${rootProject.projectDir}/src/test/resources/server.xml")
            deploy {
                apps = [rootProject.war]
            }
        }
        libertyProjectServer2 {
            serverXmlFile = file("${rootProject.projectDir}/src/test/resources/server.xml")
            deploy {
                apps = [rootProject.war]
            }
        }
    }
}

arquillianConfiguration {
    arquillianProperties = ['verifyApps': 'arquillian-tests']
    skipIfArquillianXmlExists = true
}

task deleteArquillianXml1 (type:Delete) {
    delete '../build/resources/test/arquillian.xml'
}

task deleteArquillianXml2 (type:Delete) {
    delete '../build/resources/test/arquillian.xml'
}

war.enabled = false

afterEvaluate {
    // tasks.withType(ConfigureArquillianTask).each { dependsOn 'deleteArquillianXml' }
    tasks.getByName('configureArquillian-libertyProjectServer1').dependsOn 'deleteArquillianXml1'
    tasks.getByName('configureArquillian-libertyProjectServer2').dependsOn 'deleteArquillianXml2'
}
